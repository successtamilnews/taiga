name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: taiga-ecommerce

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: taiga_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite, pdo_mysql
          coverage: xdebug

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: website/package-lock.json

      - name: Install PHP dependencies
        working-directory: backend
        run: composer install --no-dev --optimize-autoloader

      - name: Install Node dependencies
        working-directory: website
        run: npm ci

      - name: Prepare Laravel application
        working-directory: backend
        run: |
          cp .env.example .env
          php artisan key:generate
          php artisan config:cache
          php artisan route:cache

      - name: Run PHP tests
        working-directory: backend
        run: php artisan test

      - name: Build Next.js application
        working-directory: website
        run: npm run build

      - name: Run Next.js tests
        working-directory: website
        run: npm test -- --ci --coverage --watchAll=false

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend

      - name: Build and push Backend Docker image
        uses: docker/build-push-action@v5
        with:
          context: backend
          file: backend/Dockerfile.prod
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}

      - name: Extract metadata for Frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend

      - name: Build and push Frontend Docker image
        uses: docker/build-push-action@v5
        with:
          context: website
          file: website/Dockerfile.prod
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}

      - name: Deploy to production
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /var/www/taiga
            git pull origin main
            
            # Update environment variables
            cp deployment/.env.production.template backend/.env
            
            # Pull latest images
            docker compose -f deployment/docker-compose.prod.yml pull
            
            # Stop services
            docker compose -f deployment/docker-compose.prod.yml down
            
            # Start services
            docker compose -f deployment/docker-compose.prod.yml up -d
            
            # Run migrations
            docker compose -f deployment/docker-compose.prod.yml exec -T backend php artisan migrate --force
            
            # Clear caches
            docker compose -f deployment/docker-compose.prod.yml exec -T backend php artisan config:cache
            docker compose -f deployment/docker-compose.prod.yml exec -T backend php artisan route:cache
            docker compose -f deployment/docker-compose.prod.yml exec -T backend php artisan view:cache
            
            # Restart queue workers
            docker compose -f deployment/docker-compose.prod.yml restart queue-worker

  deploy-mobile:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'

      - name: Install Flutter dependencies
        working-directory: mobile/user_app
        run: flutter pub get

      - name: Build Android APK
        working-directory: mobile/user_app
        run: flutter build apk --release

      - name: Upload APK to Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID_ANDROID }}
          serviceCredentialsFileContent: ${{ secrets.CREDENTIAL_FILE_CONTENT }}
          groups: testers
          file: mobile/user_app/build/app/outputs/flutter-apk/app-release.apk

  notify:
    needs: [build-and-deploy]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Notify deployment status
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        if: always()